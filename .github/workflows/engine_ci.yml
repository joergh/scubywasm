name: Engine CI

on:
  push:
  pull_request:

jobs:
  check-format:
    name: Engine format checking
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run format check
        working-directory: engine
        run: make check-format

  lint:
    name: Engine linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run linter
        working-directory: engine
        run: make lint

  test:
    name: Engine unit tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run unit tests
        working-directory: engine
        run: make test

  coverage:
    name: Engine coverage report
    runs-on: ubuntu-latest
    needs: [check-format, lint, test]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect llvm-profdata/llvm-cov
        run: |
          set -e

          LLVM_PROFDATA=$(ls /usr/bin/llvm-profdata* 2>/dev/null | sort -V | tail -n1)
          LLVM_COV=$(ls /usr/bin/llvm-cov* 2>/dev/null | sort -V | tail -n1)

          echo "Using LLVM_PROFDATA=$LLVM_PROFDATA"
          echo "Using LLVM_COV=$LLVM_COV"

          echo "LLVM_PROFDATA=$LLVM_PROFDATA" >> "$GITHUB_ENV"
          echo "LLVM_COV=$LLVM_COV" >> "$GITHUB_ENV"

      - name: Generate coverage report
        working-directory: engine
        run: |
          make coverage
          cat build/coverage.txt

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            engine/build/coverage.txt
            engine/build/coverage.lcov
